{% extends 'index.html' %}



{% block project_list %}
<div class="project-list">
  {% if worker in project.workers.all or user.is_superuser %}
  <h1>{{ project.project_name }}</h1>
  <hr class="my-3">
  <div class="container z-depth-5 text-justify p-3 m-auto">{{ project.summary|safe }}</div>
  <div class="p-1 mt-3 grey">
    {% for task in task_list %}
    {% if not task.is_completed %}
    <div class="p-1 m-3 white">
      <div class="row align-items-center success-color-dark p-3 m-3">
        <div class="col-6 p-3 warning-color"><a title="{{ task.title }}" data-toggle="collapse" data-target="#summary{{ task.id }}"><span>{{ task.title }}</span></a></div>
      <div class="col-4">
        <div class="row">
      <div class="col"><i class="fas fa-sync more" alt="{{ task.id }}" title="synchronize"></i></div>
      {% if not task.is_active %}
      <div class="col task_status"><i class="far fa-check-square" title="start" alt="{{ task.id }}"></i></div>
      {% elif worker == task.worker %}
      <div class="col task_status"><i class="far fa-pause-circle" title="end" alt="{{ task.id }}"></i></div>
      {% else %}
      <div class="col task_status"><i class="fas fa-lock" title="active"></i></div>
      {% endif %}
      <div class="col"><i class="far fa-plus-square" id="{{ task.id }}" title="add comment"></i></div>
      </div>
      </div>
      <div class="col-2 ml-auto created_on" title="estimated time"><i class="far fa-clock">{{ task.estimated_time }}</i></div>
      <div class="text-center col-12 m-1">
        <div id="summary{{ task.id }}" class="collapse">
          <div class="container-fluid grey lighten-2 p-1">
            <div class="row white m-1">
              <div class="col-12 summary-content text-justify" contenteditable="true" id="content{{ task.id }}">{{ task.summary|safe }}</div>
              <div class="col m-1 p-1"><i class="fas fa-save" title="save" alt="{{ task.id }}"></i></div>
            </div>
            <div class="row orange accent-1">
              <div class="col-3 created_on">Created: {{ task.date_of_start }}</div>
              <div class="col-3 created_on">Priority: {{ task.get_priority_of_task_display }}</div>
              <div class="col-3 created_on">Type: {{ task.get_type_of_task_display }}</div>
              {% if task.worker %}
              <div class="col-3 task_worker created_on">Worker: {{ task.worker }}</div>
              {% else %}
              <div class="col-3 task_worker created_on">Worker: the task is free</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
      <div class="silver border border-warning p-1 m-2 text-center" id="more{{ task.id }}">
          <h5>To load the comments, just click on the sync button</h5>
      </div>
      </div>
    {% else %}
    <div class="p-1 m-3 white">
      <div class="row align-items-center  teal lighten-4 p-3 m-3">
        <div class="col-12 p-3 unique-color"><a title="completed" data-toggle="collapse" data-target="#summary{{ task.id }}"><i class="far fa-calendar-check"></i>   <span>{{ task.title }}</span></a></div>
      <div class="text-center col-12 m-1">
        <div id="summary{{ task.id }}" class="collapse">
          <div class="container-fluid grey lighten-2 p-1">
            <div class="row white m-1">
              <div class="col-12 summary-content text-justify" >{{ task.summary|safe }}</div>
            </div>
            <div class="row orange accent-1">
              <div class="col-12">End date: {{ task.date_of_end }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>
    {% endif %}
    {% endfor %}
  </div>
  {% endif %}
</div>

<div class="modal fade" id="modalCommentForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="comment-form" action="" method="POST">
        {% csrf_token %}
        <div class="modal-header text-center">
          <h4 class="modal-title w-100 font-weight-bold">Add comment</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body mx-3">
          <div class="md-form mb-5">
            <textarea type="text" id="comments" name="comment" class="form-control md-textarea" required="required"></textarea>
            <label data-error="wrong" data-success="right" for="comments">Your comments</label>
            <div id="hide" title=""></div>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-center">
          <button type="submit" class="btn btn-default">Save</button>
        </div>
    </form>
    </div>
  </div>
</div>
{% endblock %}



{% block add_comment %}
<script type="text/javascript">
  $(document).ready(function(){
      $(".fa-plus-square").click(function(){
        $('#modalCommentForm').modal('show');
        $('#hide').attr("title", this.id);
      });
  });
</script>
<script type="text/javascript">
  $(document).ready(function() {
    $('#comment-form').submit(function(event) {
    event.preventDefault();
    $.ajax({
      type: 'POST',
      url: "{% url 'add_comment' project.id %}",
      data: {
        'comment': $('#comments').val(),
        'author': $('#user_name').html(),
        'task': $('#hide').attr("title"),
        'csrfmiddlewaretoken': $("input[name=csrfmiddlewaretoken]").val()
      },
      success: function(response) {
        var id = "#more" + $('#hide').attr("title");
        $(id).html(response.comments_html);
    }
    });
    resetForm();
    return false;
  });
  });

  function resetForm() {
    $('#comments').val('');
    $('#modalCommentForm').modal('hide');
  };
</script>
{% endblock %}

{% block show_comments %}
<script type="text/javascript">
$(document).ready(function(){
  $(".more").click(function(){
      var self = $(this);
      $.ajax({
          type: 'GET',
          url: '{% url "show_comments" project.id %}',
          data: {
            'task': self.attr("alt")
          },
          success: function(response) {
            var id = "#more" + self.attr("alt");
            $(id).html(response.comments_html);
        }
      });
  });
});
</script>
{% endblock %}

{% block save_task %}
<script type="text/javascript">
  $(document).ready(function() {
    $(".fa-save").click(function(){
      var id = "#content" + $(this).attr("alt");
      $.ajax({
        type: 'POST',
        url: "{% url 'save_task' project.id %}",
        data: {
          'summary': $(id).html(),
          'task': $(this).attr("alt"),
          'csrfmiddlewaretoken': $("input[name=csrfmiddlewaretoken]").val()
        },
        success: function(response) {
          $(id).html(`${response.task.summary}`);
      }
      });
    return false;
  });
  });
</script>
{% endblock %}

{% block end_task %}
<script type="text/javascript">
  $(document).ready(function() {
    $(".fa-pause-circle").click(function(){
      $.ajax({
        type: 'POST',
        url: "{% url 'end_task' project.id %}",
        data: {
          'task': $(this).attr("alt"),
          'csrfmiddlewaretoken': $("input[name=csrfmiddlewaretoken]").val()
        },
        success: function(response) {
          $('.task_status').html(`<i class="far fa-check-square" title="start" alt="${response.task.task}"></i>`);
          $('.task_worker').html('Worker: the task is free');
      }
      });
    return false;
  });
  });
</script>
{% endblock %}

{% block start_task %}
<script type="text/javascript">
  $(document).ready(function() {
    $(".fa-check-square").click(function(){
      $.ajax({
        type: 'POST',
        url: "{% url 'start_task' project.id %}",
        data: {
          'worker': $('#user_name').attr("alt"),
          'task': $(this).attr("alt"),
          'csrfmiddlewaretoken': $("input[name=csrfmiddlewaretoken]").val()
        },
        success: function(response) {
          $('.task_status').html(`<i class="far fa-pause-circle" title="end" alt="${response.task.task}"></i>`);
          $('.task_worker').html(`Worker: ${response.task.worker}`);
      }
      });
    return false;
  });
  });
</script>
{% endblock %}
